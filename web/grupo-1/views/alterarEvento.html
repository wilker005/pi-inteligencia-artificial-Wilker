<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evento+ | Alterar Evento</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="shortcut icon" href="img/logo.svg">
    <link rel="stylesheet" type="text/css" href="css/estilocadastroEvento.css" media="screen" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12 col-xl-6 offset-xl-3" style="margin-top:2em">
                <div class="formulário">
                    <br>
                    <div class="row">
                        <div class="col-1 offset-1">
                            <a href="index.html"><span class="material-icons" style="color:#892CDC ;">arrow_back_ios</span></a>
                        </div>
                        <div class="col-8">
                            <h2 class="text-center" style="font-size: 1.5em; color:#892CDC">Alterar Evento</h2>
                        </div>
                    </div>
                    <br><br>
                    <form style="margin-left: 1.5em; margin-right: 1.5em">
                        <div class="mb-3">
                            <label for="eventoSelect" class="form-label">Selecione o evento para alterar</label>
                            <select class="form-select" id="eventoSelect">
                                <option value="" selected disabled>Escolha um evento</option>
                            </select>
                        </div>
                        <h4 style="border-left: solid 4px #892CDC; padding-left: 10px">Informações do evento</h4>
                        <div class="mb-3">
                            <label for="nome" class="form-label">Nome do evento</label>
                            <input type="text" class="form-control" id="nomeEventoInput" placeholder="" required>
                        </div>
                        <div class="row">
                            <div class="mb-3 col-4">
                                <label for="data_inicio" class="form-label">Data de Início</label>
                                <input type="date" class="form-control" id="dataInicioInput" required>
                                <small id="form-text-data" class="form-text text-muted"></small>
                            </div>
                            <div class="mb-3 col-4">
                                <label for="horario_inicio" class="form-label">Horário de Início</label>
                                <input type="time" class="form-control" id="horarioInput" required>
                            </div>
                            <div class="mb-3 col-4">
                                <label for="preco" class="form-label">Preço</label>
                                <input type="number" class="form-control" id="precoInput" placeholder="R$" required>
                                <div id="passwordHelpBlock" class="form-text" style="color: #892CDC;">
                                    Caso seja gratuito, digite 0.
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="descricao" class="form-label">Descrição</label>
                            <textarea class="form-control" id="descricaoInput" rows="3" placeholder="Digite a descrição do evento" style="border-radius:10px;" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="url_banner" class="form-label">URL do Banner</label>
                            <div class="input-group flex-nowrap">
                                <span class="input-group-text" id="iconeLink"><i class="bi bi-link-45deg"></i></span>
                                <input type="text" class="form-control" id="urlLogoInput" placeholder="Digite a URL do logo" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="url_site" class="form-label">URL do Site</label>
                            <div class="input-group flex-nowrap">
                                <span class="input-group-text" id="iconeLink"><i class="bi bi-link-45deg"></i></span>
                                <input type="text" class="form-control" id="urlSiteInput" placeholder="Digite a URL do site do evento" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="categoria" class="form-label">Categoria</label>
                            <select class="form-select" id="categoriasInput" style="border-radius: 20px;" required>
                                <option value="" selected disabled>Escolha uma categoria</option>
                                <option value="show">Show</option>
                                <option value="bazar">Bazar</option>
                                <option value="teatro">Teatro</option>
                                <option value="corrida">Corrida</option>
                                <option value="workshop">Workshop</option>
                            </select>
                            <div id="passwordHelpBlock" class="form-text" style="color: #892CDC;">
                                A Categoria escolhida acima irá definir em qual categoria o evento se enquadra para pesquisas e filtros.
                            </div>
                        </div>
                        <br>
                        <h4 style="border-left: solid 4px #892CDC; padding-left: 10px">Localização</h4>
                        <div class="mb-3">
                            <label for="cep" class="form-label">CEP</label>
                            <input type="text" class="form-control" id="cepInput" placeholder="_____-__" maxlength="9" required>
                        </div>
                        <div class="row">
                            <div class="mb-3 col-9">
                                <label for="endereco" class="form-label">Endereço</label>
                                <input type="text" class="form-control" id="enderecoInput" placeholder="Rua, Avenida..." disabled>
                            </div>
                            <div class="mb-3 col-3">
                                <label for="numero" class="form-label">Número</label>
                                <input type="text" class="form-control text-center" id="numeroInput" placeholder="nº" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="bairro" class="form-label">Bairro</label>
                            <input type="text" class="form-control" id="bairroInput" placeholder="" disabled>
                        </div>
                        <div class="mb-3">
                            <label for="cidade" class="form-label">Cidade</label>
                            <input type="text" class="form-control" id="cidadeInput" placeholder="" disabled>
                        </div>
                        <div class="form-floating-label mb-3">
                            <label for="Estado" class="form-label">Estado</label>
                            <input class="form-control" type="text" id="estadoInput" style="border-radius: 20px;" disabled>
                        </div>
                        <div class="row">
                            <div class="col-4 offset-4">
                                <button type="button" class="btn btnCadastrarEvento" style="width: 100%;" onclick="alterarEvento()">Alterar</button>
                            </div>
                        </div>
                        <br><br>
                    </form>
                </div>
                <br><br>
            </div>
            <footer>
                <div class="text-center" style="color: gray;">Eventos+ 2024</div>
            </footer>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async() => {
            await carregarEventos();
            const dataInicioInput = document.querySelector('#dataInicioInput');
            const formText = document.querySelector('#form-text-data');

            // Validação da data de início
            dataInicioInput.addEventListener('input', () => {
                const dataInicioEvento = new Date(dataInicioInput.value);
                const dataHoje = new Date();
                dataHoje.setHours(0, 0, 0, 0);

                if (dataInicioEvento < dataHoje) {
                    formText.textContent = 'A data de início deve ser igual ou maior que a data de hoje.';
                    formText.classList.add('text-danger');
                    formText.classList.remove('text-muted');
                } else {
                    formText.textContent = '';
                    formText.classList.remove('text-danger');
                    formText.classList.add('text-muted');
                }
            });

            document.querySelector('#eventoSelect').addEventListener('change', preencherFormularioEvento);
        });

        async function carregarEventos() {
            try {
                const response = await axios.get(`${protocolo}${baseURL}/eventos`);
                const eventos = response.data;
                const eventoSelect = document.querySelector('#eventoSelect');

                eventos.forEach(evento => {
                    const option = document.createElement('option');
                    option.value = evento._id;
                    option.textContent = evento.nomeEvento;
                    eventoSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar os eventos:', error);
                alert('Erro ao carregar os eventos. Tente novamente.');
            }
        }

        async function preencherFormularioEvento() {
            const eventoSelect = document.querySelector('#eventoSelect');
            const eventoId = eventoSelect.value;
            if (!eventoId || eventoId === "undefined") {
                console.error('Evento não selecionado ou ID inválido.');
                return;
            }

            if (!eventoId || eventoId === "") {
                console.error('Evento não selecionado ou ID inválido.');
                return;
            }

            try {
                const response = await axios.get(`${protocolo}${baseURL}/eventos/${eventoId}`);
                const evento = response.data;

                console.log(evento); // Log para depuração

                document.querySelector('#nomeEventoInput').value = evento.nomeEvento || '';
                document.querySelector('#dataInicioInput').value = evento.dataInicio || '';
                document.querySelector('#precoInput').value = evento.preco || '';
                document.querySelector('#descricaoInput').value = evento.descricao || '';
                document.querySelector('#urlLogoInput').value = evento.urlLogo || '';
                document.querySelector('#urlSiteInput').value = evento.urlSite || '';
                document.querySelector('#cepInput').value = evento.cep || '';
                document.querySelector('#enderecoInput').value = evento.endereco || '';
                document.querySelector('#numeroInput').value = evento.numero || '';
                document.querySelector('#cidadeInput').value = evento.cidade || '';
                document.querySelector('#estadoInput').value = evento.estado || '';
                document.querySelector('#categoriasInput').value = evento.categorias || '';
                document.querySelector('#bairroInput').value = evento.bairro || '';
                document.querySelector('#horarioInput').value = evento.horario || '';

                // Habilitar os campos caso estejam desabilitados
                document.querySelector('#enderecoInput').disabled = false;
                document.querySelector('#bairroInput').disabled = false;
                document.querySelector('#cidadeInput').disabled = false;
            } catch (error) {
                console.error('Erro ao buscar os dados do evento:', error);
                alert('Erro ao buscar os dados do evento. Tente novamente.');
            }
        }

        async function buscarCEP(cep) {
            try {
                const url = `https://viacep.com.br/ws/${cep}/json/`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.erro) {
                    alert("CEP não encontrado!");
                    limparCampos();
                } else {
                    preencherCampos(data);
                }
            } catch (error) {
                console.error("Erro ao buscar o CEP:", error);
                alert("Erro ao buscar o CEP. Tente novamente.");
                limparCampos();
            }
        }

        function preencherCampos(data) {
            document.querySelector("#enderecoInput").value = data.logradouro;
            document.querySelector("#cidadeInput").value = data.localidade;
            document.querySelector("#bairroInput").value = data.bairro;
        }

        function limparCampos() {
            document.querySelector("#enderecoInput").value = "";
            document.querySelector("#cidadeInput").value = "";
            document.querySelector("#bairroInput").value = "";
        }

        document.querySelector("#cepInput").addEventListener("blur", function() {
            const cep = this.value.replace(/\D/g, "");
            if (cep.length === 8) {
                buscarCEP(cep);
            } else {
                alert("Por favor, digite um CEP válido com 8 dígitos.");
                limparCampos();
            }
        });

        const protocolo = 'http://';
        const baseURL = 'localhost:3000';

        async function alterarEvento() {
            let eventoId = document.querySelector('#eventoSelect').value;

            if (!eventoId) {
                alert('Evento não selecionado!');
                return;
            }

            console.log('ID do evento:', eventoId); // Log do ID do evento

            let nomeEventoInput = document.querySelector('#nomeEventoInput');
            let dataInicioInput = document.querySelector('#dataInicioInput');
            let precoInput = document.querySelector('#precoInput');
            let descricaoInput = document.querySelector('#descricaoInput');
            let urlLogoInput = document.querySelector('#urlLogoInput');
            let urlSiteInput = document.querySelector('#urlSiteInput');
            let enderecoInput = document.querySelector('#enderecoInput');
            let cidadeInput = document.querySelector('#cidadeInput');
            let estadoInput = document.querySelector('#estadoInput');
            let categoriasInput = document.querySelector('#categoriasInput');
            let numeroInput = document.querySelector('#numeroInput');
            let cepInput = document.querySelector('#cepInput');
            let bairroInput = document.querySelector('#bairroInput');

            let nomeEvento = nomeEventoInput.value;
            let dataInicio = dataInicioInput.value;
            let preco = precoInput.value && parseFloat(precoInput.value) > 0 ? precoInput.value : "Grátis";
            let descricao = descricaoInput.value;
            let urlLogo = urlLogoInput.value;
            let urlSite = urlSiteInput.value;
            let endereco = enderecoInput.value;
            let cidade = cidadeInput.value;
            let estado = estadoInput.value;
            let categoria = categoriasInput.value;
            let numero = numeroInput.value;
            let cep = cepInput.value;
            let bairro = bairroInput.value;

            if (!nomeEvento || !dataInicio || !preco || !descricao || !urlLogo || !urlSite || !endereco || !cidade || !estado || !categoria) {
                alert('Por favor, preencha todos os campos antes de alterar.');
                return;
            }

            try {
                const alterarEndpoint = `/api/eventos/${eventoId}`;
                const URLCompleta = `${protocolo}${baseURL}${alterarEndpoint}`;

                console.log('URL para atualizar evento:', URLCompleta); // Log da URL completa

                await axios.put(URLCompleta, {
                    nomeEvento: nomeEvento,
                    dataInicio: dataInicio,
                    preco: preco,
                    descricao: descricao,
                    urlLogo: urlLogo,
                    urlSite: urlSite,
                    cep: cep,
                    endereco: endereco,
                    numero: numero,
                    cidade: cidade,
                    estado: estado,
                    categorias: categoria,
                    bairro: bairro
                });

                alert('Evento alterado com sucesso!');

                // Limpar os campos após sucesso
                nomeEventoInput.value = "";
                dataInicioInput.value = "";
                precoInput.value = "";
                descricaoInput.value = "";
                urlLogoInput.value = "";
                urlSiteInput.value = "";
                enderecoInput.value = "";
                cidadeInput.value = "";
                estadoInput.value = "";
                categoriasInput.value = "";
                numeroInput.value = "";
                cepInput.value = "";
                bairroInput.value = "";
            } catch (error) {
                console.error('Erro ao alterar o evento:', error.response);
                alert('Erro ao alterar o evento. Tente novamente.');
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</body>

</html>